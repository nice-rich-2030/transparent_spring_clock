# 観賞用スプリング式時計 3Dビューア 仕様書 (SPEC.md)

## 1.1 課題分析・機能提案

### 課題
機械式時計（スプリングドライブ）の精巧な内部機構は、実物では外装に覆われて見えづらい。時計愛好家や学習者が、ゼンマイ・歯車・脱進機などの動作原理を直感的に理解・観賞できる手段が限られている。

### 解決策
three.js を用いた3Dインタラクティブビューアを開発。すべての部品を半透明でレンダリングし、内部機構が透けて見える「スケルトン時計」を実現。ユーザーは自由にカメラを操作し、あらゆる角度から時計の動きを観賞できる。

### 潜在的課題の提案
1. **パフォーマンス**: 100個以上の部品を半透明でリアルタイム描画するには、適切なLOD（詳細度）管理が必要
2. **透明度の描画順序**: 半透明オブジェクトの重なり順が正しく描画されないZ-Fighting問題への対策
3. **時刻精度**: 日本時間を正確に取得し、スイープ運針を滑らかに表現するフレームレート管理

### 主要機能

| 区分 | 機能 |
|------|------|
| 入力 | システム時刻（日本時間）、マウス/タッチ操作（カメラ制御） |
| 処理 | 時刻に基づく各歯車・針の回転角度計算、物理シミュレーション風アニメーション |
| 出力 | 半透明3Dモデルのリアルタイムレンダリング、滑らかなスイープ運針表示 |
| 外部連携 | なし（オフライン動作可能） |
| メンテナンス | デバッグモード（ワイヤーフレーム表示、FPS表示、部品ハイライト） |

---

## 1.2 技術スタック選定・選定根拠

| カテゴリ | 選定技術 | 選定理由 |
|----------|----------|----------|
| 言語 | TypeScript | 型安全性により複雑な3D座標計算のバグを防止 |
| 3Dライブラリ | three.js (r160+) | Webブラウザ3Dのデファクトスタンダード、豊富なドキュメント |
| ビルドツール | Vite | 高速なHMR、TypeScript対応、シンプルな設定 |
| カメラ制御 | OrbitControls | three.js標準の回転・ズーム・パン操作 |
| マテリアル | MeshPhysicalMaterial | 半透明ガラス表現、屈折・反射のリアルな質感 |
| ライティング | HDR環境マップ + ポイントライト | 時計の光沢・輝きを美しく表現 |

### 対象ブラウザ
- Chrome 90+, Firefox 90+, Safari 15+, Edge 90+
- WebGL 2.0 対応必須

---

## 1.3 機能詳細化 (ブレイクダウン)

### 主要機能 1: 時刻表示・針の駆動
- 1.1 日本時間（JST）の取得
- 1.2 時針・分針・秒針の角度計算
- 1.3 **スイープ運針**（秒針が滑らかに連続回転）
- 1.4 各歯車の連動回転（ギア比に基づく）

### 主要機能 2: 3D部品モデリング・レンダリング
- 2.1 香箱（バレル）+ 主ゼンマイ
- 2.2 輪列（5枚の歯車 + 軸）
- 2.3 脱進機（ガンギ車 + アンクル）
- 2.4 調速機（てんぷ + ひげゼンマイ）
- 2.5 発電機構（ローター + コイル + 磁石）
- 2.6 IC・水晶振動子（象徴的表現）
- 2.7 時針・分針・秒針
- 2.8 文字盤・ケース・風防

### 主要機能 3: 半透明レンダリング
- 3.1 各部品の透明度設定（0.3〜0.7）
- 3.2 深度ソート（Depth Peeling 風）
- 3.3 屈折・反射エフェクト
- 3.4 発光エフェクト（ルビー軸受け、水晶振動子）

### 主要機能 4: カメラ・インタラクション
- 4.1 OrbitControls（回転・ズーム・パン）
- 4.2 自動回転モード（トグル切替）
- 4.3 プリセット視点（正面・裏面・側面・ムーブメント寄り）
- 4.4 部品クリックでハイライト＆情報表示

### 主要機能 5: UI・デバッグ
- 5.1 現在時刻表示（デジタル）
- 5.2 FPSカウンター
- 5.3 ワイヤーフレームモード切替
- 5.4 部品名ツールチップ

---

## 1.4 データモデル・データ構造定義

### 部品エンティティ

```
WatchPart {
  id: string                    // 部品識別子
  name: string                  // 日本語名
  nameEn: string                // 英語名
  mesh: THREE.Mesh              // 3Dメッシュ
  parent: WatchPart | null      // 親部品（回転連動用）
  rotationAxis: Vector3         // 回転軸
  rotationSpeed: number         // 回転速度係数
  transparency: number          // 透明度 (0-1)
  emissive: boolean             // 発光するか
  description: string           // 説明文
}
```

### 歯車連動データ

```
GearTrain {
  gears: Gear[]                 // 歯車配列
}

Gear {
  id: string
  teeth: number                 // 歯数
  connectedTo: string[]         // 噛み合う歯車ID
  gearRatio: number             // ギア比
}
```

### 時刻データ

```
TimeState {
  hours: number                 // 0-23
  minutes: number               // 0-59
  seconds: number               // 0-59.999... (小数点以下でスイープ)
  totalSeconds: number          // 00:00:00からの経過秒
}
```

---

## 1.5 ユーザー操作シナリオ

### インストール・起動
1. ユーザーがHTMLファイルをブラウザで開く（またはURLにアクセス）
2. three.js シーンが初期化され、時計が正面視点で表示される
3. ローディング完了後、現在の日本時間で針が動き始める

### 利用
1. **観賞**: 時計が日本時間を表示し、秒針がスイープ運針で滑らかに動く
2. **カメラ操作**: マウスドラッグで回転、ホイールでズーム、右ドラッグでパン
3. **視点切替**: UIボタンで正面・裏面・側面・ムーブメント寄りを選択
4. **自動回転**: トグルボタンで時計がゆっくり自動回転
5. **部品情報**: 部品をクリックするとハイライト表示＋説明パネル表示

### 終了
- ブラウザを閉じるだけ（状態保存不要）

---

## 1.6 UI分析・提案

### 画面レイアウト

```
+------------------------------------------------------------------+
|  [観賞用スプリング式時計]                          [?] [設定]    |
+------------------------------------------------------------------+
|                                                                  |
|                                                                  |
|                     +------------------+                         |
|                     |                  |                         |
|                     |   3D時計表示     |                         |
|                     |   (メイン領域)   |                         |
|                     |                  |                         |
|                     +------------------+                         |
|                                                                  |
|                                                                  |
+------------------------------------------------------------------+
| [正面] [裏面] [側面] [機構]  |  現在時刻: 14:32:45  |  60 FPS   |
+------------------------------------------------------------------+
```

### サイドパネル（部品クリック時）

```
+----------------------+
| 香箱（バレル）       |
+----------------------+
| 主ゼンマイを収納する |
| 円柱形のケース。     |
| ゼンマイがほどける   |
| 力で歯車を回転。     |
+----------------------+
| [閉じる]             |
+----------------------+
```

### エラーハンドリング
- WebGL非対応: 「お使いのブラウザはWebGLに対応していません」メッセージ表示
- 低FPS検出: 「パフォーマンスモード」を提案（影・反射の簡略化）

---

## 1.7 フォルダ・ファイル構成

```
transparent_spring_clock/
├── index.html                 # エントリーポイント
├── package.json               # 依存関係
├── tsconfig.json              # TypeScript設定
├── vite.config.ts             # Vite設定
├── src/
│   ├── main.ts                # アプリ初期化 (~100行)
│   ├── scene/
│   │   ├── SceneManager.ts    # シーン・カメラ・ライト管理 (~200行)
│   │   └── Renderer.ts        # レンダラー設定・アニメーションループ (~150行)
│   ├── watch/
│   │   ├── WatchAssembly.ts   # 時計全体の組み立て (~250行)
│   │   ├── parts/
│   │   │   ├── Barrel.ts      # 香箱 (~100行)
│   │   │   ├── GearTrain.ts   # 輪列（5枚歯車） (~300行)
│   │   │   ├── Escapement.ts  # 脱進機（ガンギ車・アンクル） (~200行)
│   │   │   ├── Balance.ts     # 調速機（てんぷ・ひげゼンマイ） (~150行)
│   │   │   ├── Generator.ts   # 発電機構（ローター・コイル） (~200行)
│   │   │   ├── Quartz.ts      # IC・水晶振動子 (~100行)
│   │   │   ├── Hands.ts       # 時針・分針・秒針 (~150行)
│   │   │   └── Case.ts        # 文字盤・ケース・風防 (~200行)
│   │   └── materials/
│   │       └── TransparentMaterial.ts  # 半透明マテリアル共通 (~100行)
│   ├── time/
│   │   └── TimeController.ts  # 時刻取得・針角度計算 (~100行)
│   ├── controls/
│   │   └── CameraController.ts # カメラ操作・プリセット視点 (~150行)
│   ├── ui/
│   │   ├── UIManager.ts       # UI全体管理 (~150行)
│   │   ├── InfoPanel.ts       # 部品情報パネル (~100行)
│   │   └── DebugPanel.ts      # デバッグ情報（FPS等） (~80行)
│   └── types/
│       └── index.ts           # 型定義 (~100行)
├── public/
│   ├── textures/              # テクスチャ画像
│   │   └── environment.hdr    # 環境マップ
│   └── styles/
│       └── main.css           # スタイルシート
└── README.md
```

**総行数見積もり**: 約2,500行（各ファイル800行以下を遵守）

---

## 1.8 実装概要

| ファイル | 役割 | 処理概要 |
|----------|------|----------|
| main.ts | エントリー | DOM読込後にSceneManager・WatchAssembly初期化 |
| SceneManager.ts | シーン管理 | Scene・Camera・Light・環境マップ設定 |
| Renderer.ts | 描画 | WebGLRenderer設定、アニメーションループ、リサイズ対応 |
| WatchAssembly.ts | 時計組立 | 全部品を生成・配置し、親子関係を構築 |
| GearTrain.ts | 輪列 | 5枚の歯車をギア比に基づき連動回転 |
| Escapement.ts | 脱進機 | ガンギ車の間欠回転、アンクルの振動 |
| Balance.ts | 調速機 | てんぷの振り子運動をシミュレート |
| Generator.ts | 発電機構 | ローターの回転、電磁ブレーキ表現（発光変化） |
| Hands.ts | 針 | 時刻に基づく角度計算、スイープ運針 |
| TransparentMaterial.ts | マテリアル | 半透明・屈折・発光マテリアル生成 |
| TimeController.ts | 時刻 | JST取得、秒の小数点以下を含む精密時刻 |
| CameraController.ts | カメラ | OrbitControls、プリセット視点、自動回転 |
| UIManager.ts | UI | ボタン・パネル配置、イベントハンドリング |

---

## 1.9 メンテナンス・セキュリティ

### デバッグ機能
- **FPSカウンター**: stats.js によるリアルタイムFPS表示
- **ワイヤーフレームモード**: 部品の形状確認用
- **部品ハイライト**: クリックで選択部品を発光表示
- **コンソールログ**: 初期化完了、エラー発生時にログ出力

### パフォーマンス対策
- **LOD（Level of Detail）**: カメラ距離に応じて歯車の歯数を簡略化
- **パフォーマンスモード**: 低スペック環境で影・反射を無効化
- **requestAnimationFrame**: ブラウザ最適化されたアニメーションループ

### セキュリティ
- 外部API接続なし（オフライン動作）
- ユーザー入力なし（インジェクションリスクなし）
- ローカルストレージ不使用（個人情報保存なし）

---

## 変更履歴

| 日付 | 版 | 変更内容 |
|------|-----|----------|
| 2026-02-07 | 1.0 | 初版作成 |
