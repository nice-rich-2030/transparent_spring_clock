# 観賞用スプリング式時計 3Dビューア 仕様書整合性確認 (SPEC_VALIDATION.md)

---

## 4.1 整合性確認の目的と方法

### 目的
SPEC.md、SPEC_DETAIL.md、SPEC_LOGIC.md の3つの仕様書が矛盾なく整合していることを確認し、コーディング開始前に設計の品質を保証する。

### 確認項目
1. **機能整合性**: 各機能が全フェーズで同一に定義されているか
2. **データモデル整合性**: エンティティ・属性が一致しているか
3. **ファイル構成整合性**: ファイル名・役割・行数制約が守られているか
4. **技術スタック整合性**: 選定技術が全フェーズで使用されているか
5. **セキュリティ・保守性整合性**: 対策が全フェーズで言及されているか

---

## 4.2 機能整合性確認表

### 主要機能 1: 時刻表示・針の駆動

| # | サブ機能 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 | 備考 |
|---|----------|---------|----------------|----------------|--------|------|
| 1.1 | 日本時間（JST）取得 | ✅ 1.3 | ✅ TimeController.ts | ✅ 3.1 | ✅ | - |
| 1.2 | 時針・分針・秒針の角度計算 | ✅ 1.3 | ✅ Hands.ts | ✅ 3.1 | ✅ | - |
| 1.3 | スイープ運針 | ✅ 1.3 | ✅ Hands.ts | ✅ 3.1 | ✅ | ミリ秒精度で実装 |
| 1.4 | 歯車の連動回転 | ✅ 1.3 | ✅ GearTrain.ts | ✅ 3.2 | ✅ | ギア比計算詳細化 |

### 主要機能 2: 3D部品モデリング・レンダリング

| # | サブ機能 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 | 備考 |
|---|----------|---------|----------------|----------------|--------|------|
| 2.1 | 香箱 + 主ゼンマイ | ✅ 1.3 | ✅ Barrel.ts | - | ✅ | ロジック不要 |
| 2.2 | 輪列（5枚歯車） | ✅ 1.3 | ✅ GearTrain.ts | ✅ 3.2 | ✅ | - |
| 2.3 | 脱進機 | ✅ 1.3 | ✅ Escapement.ts | ✅ 3.4 | ✅ | - |
| 2.4 | 調速機 | ✅ 1.3 | ✅ Balance.ts | ✅ 3.4 | ✅ | てんぷ振動 |
| 2.5 | 発電機構 | ✅ 1.3 | ✅ Generator.ts | ✅ 3.5 | ✅ | 電磁ブレーキ表現 |
| 2.6 | IC・水晶振動子 | ✅ 1.3 | ✅ Quartz.ts | ✅ 3.5 | ✅ | 発光表現 |
| 2.7 | 時針・分針・秒針 | ✅ 1.3 | ✅ Hands.ts | ✅ 3.1 | ✅ | - |
| 2.8 | 文字盤・ケース・風防 | ✅ 1.3 | ✅ Case.ts | - | ✅ | ロジック不要 |

### 主要機能 3: 半透明レンダリング

| # | サブ機能 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 | 備考 |
|---|----------|---------|----------------|----------------|--------|------|
| 3.1 | 透明度設定（0.3〜0.7） | ✅ 1.3 | ✅ TransparentMaterial.ts | ✅ 3.3 | ✅ | - |
| 3.2 | 深度ソート | ✅ 1.3 | ✅ TransparentMaterial.ts | ✅ 3.3 | ✅ | renderOrder設定 |
| 3.3 | 屈折・反射エフェクト | ✅ 1.3 | ✅ TransparentMaterial.ts | - | ✅ | MeshPhysicalMaterial |
| 3.4 | 発光エフェクト | ✅ 1.3 | ✅ TransparentMaterial.ts | ✅ 3.5 | ✅ | 軸受け・水晶 |

### 主要機能 4: カメラ・インタラクション

| # | サブ機能 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 | 備考 |
|---|----------|---------|----------------|----------------|--------|------|
| 4.1 | OrbitControls | ✅ 1.3 | ✅ CameraController.ts | - | ✅ | three.js標準 |
| 4.2 | 自動回転モード | ✅ 1.3 | ✅ CameraController.ts | - | ✅ | トグル切替 |
| 4.3 | プリセット視点 | ✅ 1.3 | ✅ CameraController.ts | ✅ 3.6 | ✅ | イージング補間 |
| 4.4 | 部品クリックハイライト | ✅ 1.3 | ✅ WatchAssembly.ts | ✅ 3.7 | ✅ | レイキャスト |

### 主要機能 5: UI・デバッグ

| # | サブ機能 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 | 備考 |
|---|----------|---------|----------------|----------------|--------|------|
| 5.1 | 現在時刻表示 | ✅ 1.3 | ✅ UIManager.ts | - | ✅ | - |
| 5.2 | FPSカウンター | ✅ 1.3 | ✅ DebugPanel.ts | - | ✅ | stats.js |
| 5.3 | ワイヤーフレームモード | ✅ 1.3 | ✅ DebugPanel.ts | - | ✅ | トグル |
| 5.4 | 部品名ツールチップ | ✅ 1.3 | ✅ InfoPanel.ts | - | ✅ | クリック時表示 |

---

## 4.3 データモデル整合性確認表

| # | エンティティ | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 | 備考 |
|---|-------------|---------|----------------|----------------|--------|------|
| 1 | WatchPart | ✅ 1.4 | ✅ types/index.ts | ✅ 3.7 | ✅ | 部品情報 |
| 2 | Gear | ✅ 1.4 | ✅ types/index.ts | ✅ 3.2 | ✅ | 歯車データ |
| 3 | GearTrain | ✅ 1.4 | ✅ GearTrain.ts | ✅ 3.2 | ✅ | 歯車配列 |
| 4 | TimeState | ✅ 1.4 | ✅ types/index.ts | ✅ 3.1 | ✅ | 時刻データ |
| 5 | CameraPreset | - | ✅ types/index.ts | ✅ 3.6 | ⚠️ | SPEC.mdに追記推奨 |
| 6 | AppConfig | - | ✅ types/index.ts | - | ⚠️ | SPEC.mdに追記推奨 |

### 修正内容（⚠️箇所）

**CameraPreset / AppConfig について**:
- SPEC.md のデータモデル定義（1.4）に明示的な記載がなかったが、SPEC_DETAIL.md で型定義されている
- 機能としては1.3で「プリセット視点」「デバッグモード」が言及されており、暗黙的に定義済み
- **判定**: 軽微な不整合のため、SPEC.md への追記は任意とする

---

## 4.4 ファイル構成整合性確認表

| # | ファイル | SPEC.md 記載 | SPEC_DETAIL.md 記載 | 推定行数 | 800行制約 | 備考 |
|---|----------|-------------|---------------------|----------|-----------|------|
| 1 | main.ts | ✅ | ✅ | ~100 | ✅ | - |
| 2 | SceneManager.ts | ✅ | ✅ | ~200 | ✅ | - |
| 3 | Renderer.ts | ✅ | ✅ | ~150 | ✅ | - |
| 4 | WatchAssembly.ts | ✅ | ✅ | ~250 | ✅ | - |
| 5 | Barrel.ts | ✅ | ✅ | ~100 | ✅ | - |
| 6 | GearTrain.ts | ✅ | ✅ | ~300 | ✅ | - |
| 7 | Escapement.ts | ✅ | ✅ | ~200 | ✅ | - |
| 8 | Balance.ts | ✅ | ✅ | ~150 | ✅ | - |
| 9 | Generator.ts | ✅ | ✅ | ~200 | ✅ | - |
| 10 | Quartz.ts | ✅ | ✅ | ~100 | ✅ | - |
| 11 | Hands.ts | ✅ | ✅ | ~150 | ✅ | - |
| 12 | Case.ts | ✅ | ✅ | ~200 | ✅ | - |
| 13 | TransparentMaterial.ts | ✅ | ✅ | ~100 | ✅ | - |
| 14 | TimeController.ts | ✅ | ✅ | ~100 | ✅ | - |
| 15 | CameraController.ts | ✅ | ✅ | ~150 | ✅ | - |
| 16 | UIManager.ts | ✅ | ✅ | ~150 | ✅ | - |
| 17 | InfoPanel.ts | ✅ | ✅ | ~100 | ✅ | - |
| 18 | DebugPanel.ts | ✅ | ✅ | ~80 | ✅ | - |
| 19 | types/index.ts | ✅ | ✅ | ~100 | ✅ | - |

**総行数**: 約2,580行（800行制約を全ファイルで遵守）

---

## 4.5 技術スタック整合性確認表

| # | 技術 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 |
|---|------|---------|----------------|----------------|--------|
| 1 | TypeScript | ✅ 1.2 | ✅ 全ファイル.ts | ✅ 疑似コード参考 | ✅ |
| 2 | three.js (r160+) | ✅ 1.2 | ✅ 全3D関連 | ✅ Mesh/Material参照 | ✅ |
| 3 | Vite | ✅ 1.2 | ✅ vite.config.ts | - | ✅ |
| 4 | OrbitControls | ✅ 1.2 | ✅ CameraController.ts | ✅ 3.6 | ✅ |
| 5 | MeshPhysicalMaterial | ✅ 1.2 | ✅ TransparentMaterial.ts | ✅ 3.3 | ✅ |
| 6 | HDR環境マップ | ✅ 1.2 | ✅ SceneManager.ts | - | ✅ |
| 7 | stats.js | ✅ 1.9 | ✅ DebugPanel.ts | - | ✅ |

---

## 4.6 セキュリティ・保守性整合性確認表

| # | 項目 | SPEC.md | SPEC_DETAIL.md | SPEC_LOGIC.md | 整合性 |
|---|------|---------|----------------|----------------|--------|
| 1 | WebGL非対応エラー処理 | ✅ 1.6 | ✅ main.ts | - | ✅ |
| 2 | 低FPS検出・パフォーマンスモード | ✅ 1.6 | ✅ DebugPanel.ts | ✅ 各ロジック目標 | ✅ |
| 3 | 外部API接続なし | ✅ 1.9 | ✅ - | - | ✅ |
| 4 | ユーザー入力なし | ✅ 1.9 | ✅ - | - | ✅ |
| 5 | ローカルストレージ不使用 | ✅ 1.9 | ✅ - | - | ✅ |
| 6 | FPSカウンター | ✅ 1.9 | ✅ DebugPanel.ts | - | ✅ |
| 7 | ワイヤーフレームモード | ✅ 1.9 | ✅ DebugPanel.ts | - | ✅ |
| 8 | コンソールログ | ✅ 1.9 | ✅ main.ts | - | ✅ |

---

## 4.7 修正サマリー

### 発見された不整合

| # | 箇所 | 内容 | 重要度 | 対応 |
|---|------|------|--------|------|
| 1 | SPEC.md 1.4 | CameraPreset型が未記載 | 軽微 | 任意追記 |
| 2 | SPEC.md 1.4 | AppConfig型が未記載 | 軽微 | 任意追記 |

### 対応方針
- 上記2点は軽微な不整合であり、SPEC_DETAIL.md の types/index.ts で詳細定義されているため、実装に支障なし
- 必要に応じて SPEC.md 1.4 に追記可能だが、現時点では修正不要と判断

---

## 4.8 最終確認チェックリスト

| # | 確認項目 | 状態 |
|---|----------|------|
| ✅ | すべての主要機能が3つの仕様書で一致している | 完了 |
| ✅ | すべてのデータエンティティが定義・説明されている | 完了（軽微な追記推奨あり） |
| ✅ | ファイル構成が800行制約を守っている | 完了（全19ファイル確認済） |
| ✅ | 技術スタックが全フェーズで一貫している | 完了 |
| ✅ | セキュリティ・保守性対策が全フェーズで説明されている | 完了 |
| ✅ | パフォーマンス目標が明記されている | 完了（SPEC_LOGIC.md） |
| ✅ | エラーハンドリングが設計されている | 完了（WebGL非対応、低FPS） |

---

## 4.9 コーディング開始前の最終確認

### 仕様書一覧

| ドキュメント | 状態 | ページ数（推定） |
|-------------|------|------------------|
| SPEC.md | ✅ 完成 | A4約4枚 |
| SPEC_DETAIL.md | ✅ 完成 | A4約10枚 |
| SPEC_LOGIC.md | ✅ 完成 | A4約6枚 |
| SPEC_VALIDATION.md | ✅ 完成（本ドキュメント） | A4約4枚 |

### 次のステップ
1. ユーザーによる最終承認
2. コーディング開始承認の取得
3. `npm create vite@latest` によるプロジェクト初期化
4. 仕様書に基づく実装開始

---

## 変更履歴

| 日付 | 版 | 変更内容 |
|------|-----|----------|
| 2026-02-07 | 1.0 | 初版作成・整合性確認完了 |
